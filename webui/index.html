<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<link rel="icon" type="image/svg+xml" href="favicon.svg" sizes="any">

		<title>ComNets Channel Emulator</title>

		<link rel="stylesheet" href="css/reset.css">
		<link rel="stylesheet" href="css/ui.css">
		<link rel="stylesheet" href="js/node_editor/node_editor.css">

		<script src="js/jquery/jquery-3.5.1.min.js"></script>
		<script src="js/node_editor/node_editor.js"></script>
		<script src="js/mqtt/mqttjs.js"></script>
		<script src="js/mqtt/mqtt.js"></script>
	</head>
	<body>
		<div class="header">
			<img class="logo" src="img/comnets_logo.png">
			<!--<a>Channel Emulator</a>-->
		</div>

		<div class="content">
			<div id="node_library"></div>
			<div id="node_editor"></div>
		</div>

		<script>
			var node_editor = new NodeEditor("#node_editor");

			subscribe("get/module/+", function(topic, message) {
				var r = new RegExp("get\\/module\\/(\\w+)");
				var m;
				if((m = r.exec(topic)) === null) {
					return;
				}
				var node_id = m[1];

				var node_data = (message.length > 0 ? JSON.parse(message) : null);

				if(node_id in node_editor.nodes) {
					if(node_data !== null) {
						node_editor.updateNode(node_id, node_data, false);
					} else {
						node_editor.removeNode(node_editor.nodes[node_id], false);
					}
				} else if(node_data !== null) {
					var node = new Node(node_id);
					node.deserialize(node_data);
					node_editor.addNode(node, false);
				}
			});

			subscribe("get/paths", function(topic, message) {
				var paths_data = (message.length > 0 ? JSON.parse(message) : null);

				if(paths_data) {
					node_editor.updatePaths(paths_data, false);
				}
			});

			subscribe("get/module/+/+", function(topic, message) {
				var r = new RegExp("get\\/module\\/(\\w+)/(\\w+)");
				var m;
				if((m = r.exec(topic)) === null) {
					return;
				}
				var node_id = m[1];
				var parameter_id = m[2];

				if(node_id in node_editor.nodes && parameter_id in node_editor.nodes[node_id].parameters) {
					node_editor.nodes[node_id].parameters[parameter_id].setValue(parseFloat(message));
				}
			});

			node_editor.setNodeAddHandler(function(node) {
				publish("set/module/" + node.id, node.serialize());
			});

			node_editor.setNodeChangeHandler(function(node) {
				publish("set/module/" + node.id, node.serialize());
			});

			node_editor.setNodeRemoveHandler(function(node) {
				publish("set/module/" + node.id, null);
			});

			node_editor.setPathAddHandler(function(path) {
				publish("set/paths", node_editor.serializePaths());
			});

			node_editor.setPathRemoveHandler(function(path) {
				publish("set/paths", node_editor.serializePaths());
			});

			node_editor.setParameterChangeHandler(function(node, parameter_id, value) {
				publish("set/module/" + node.id + "/" + parameter_id, value.toString());
			});

			var node_library = new NodeLibrary("#node_library");
			node_library.connectNodeEditor(node_editor);

			var loss_group = new NodeLibraryGroup("Loss");

			var uncorrelated_loss = new Node("uncorrelated_loss");
			uncorrelated_loss.setType("uncorrelated_loss");
			uncorrelated_loss.setTitle("Uncorrelated Loss");
			var flow = new NodeContentFlow();
			flow.addPort("left", new Port("lr_in", "receiving", "In"));
			flow.addPort("left", new Port("rl_out", "sending", "Out"));
			flow.addPort("right", new Port("lr_out", "sending", "Out"));
			flow.addPort("right", new Port("rl_in", "receiving", "In"));
			uncorrelated_loss.addContentItem(flow)
			uncorrelated_loss.addContentItem(new NodeContentParameter("loss", "Loss", "%", false, 0, 100, 1));
			uncorrelated_loss.addContentItem(new NodeContentParameter("seed", "Seed", "", true, 0, null, 1));
			loss_group.addNode(uncorrelated_loss);

			var gilbert_elliot_loss = new Node("gilbert_elliot_loss");
			gilbert_elliot_loss.setType("gilbert_elliot_loss");
			gilbert_elliot_loss.setTitle("Gilbert-Elliot Loss");
			var flow = new NodeContentFlow();
			flow.addPort("left", new Port("lr_in", "receiving", "In"));
			flow.addPort("left", new Port("rl_out", "sending", "Out"));
			flow.addPort("right", new Port("lr_out", "sending", "Out"));
			flow.addPort("right", new Port("rl_in", "receiving", "In"));
			gilbert_elliot_loss.addContentItem(flow)
			gilbert_elliot_loss.addContentItem(new NodeContentParameter("p_01", "p_01", "1/ms", false, 0, null, 10));
			gilbert_elliot_loss.addContentItem(new NodeContentParameter("p_10", "p_10", "1/ms", false, 0, null, 10));
			gilbert_elliot_loss.addContentItem(new NodeContentParameter("e_0", "e_0", "%", false, 0, 100, 1));
			gilbert_elliot_loss.addContentItem(new NodeContentParameter("e_1", "e_1", "%", false, 0, 100, 1));
			loss_group.addNode(gilbert_elliot_loss);

			node_library.addGroup(loss_group);


			var delay_group = new NodeLibraryGroup("Delay");

			var fixed_delay = new Node("fixed_delay");
			fixed_delay.setType("fixed_delay");
			fixed_delay.setTitle("Fixed Delay");
			var flow = new NodeContentFlow();
			flow.addPort("left", new Port("lr_in", "receiving", "In"));
			flow.addPort("left", new Port("rl_out", "sending", "Out"));
			flow.addPort("right", new Port("lr_out", "sending", "Out"));
			flow.addPort("right", new Port("rl_in", "receiving", "In"));
			fixed_delay.addContentItem(flow)
			fixed_delay.addContentItem(new NodeContentParameter("delay", "Delay", "ms", false, 0, null, 10));
			delay_group.addNode(fixed_delay);

			node_library.addGroup(delay_group);


			var queue_group = new NodeLibraryGroup("Queue");

			var dql_queue = new Node("dql_queue");
			dql_queue.setType("dql_queue");
			dql_queue.setTitle("DQL Queue");
			var flow = new NodeContentFlow();
			flow.addPort("left", new Port("in", "receiving", "In"));
			flow.addPort("right", new Port("out", "responding", "Out"));
			dql_queue.addContentItem(flow)
			queue_group.addNode(dql_queue);

			var fifo_queue = new Node("fifo_queue");
			fifo_queue.setType("fifo_queue");
			fifo_queue.setTitle("FIFO Queue");
			var flow = new NodeContentFlow();
			flow.addPort("left", new Port("in", "receiving", "In"));
			flow.addPort("right", new Port("out", "responding", "Out"));
			fifo_queue.addContentItem(flow)
			queue_group.addNode(fifo_queue);

			node_library.addGroup(queue_group);


			var rate_group = new NodeLibraryGroup("Rate");

			var bitrate_rate = new Node("bitrate_rate");
			bitrate_rate.setType("bitrate_rate");
			bitrate_rate.setTitle("Bitrate Rate");
			var flow = new NodeContentFlow();
			flow.addPort("left", new Port("in", "requesting", "In"));
			flow.addPort("right", new Port("out", "sending", "Out"));
			bitrate_rate.addContentItem(flow)
			bitrate_rate.addContentItem(new NodeContentParameter("bitrate", "Bitrate", "bit/s", true, 0, null, 1000));
			rate_group.addNode(bitrate_rate);

			var fixed_interval_rate = new Node("fixed_interval_rate");
			fixed_interval_rate.setType("fixed_interval_rate");
			fixed_interval_rate.setTitle("Fixed Interval Rate");
			var flow = new NodeContentFlow();
			flow.addPort("left", new Port("lr_in", "requesting", "In"));
			flow.addPort("left", new Port("rl_out", "sending", "Out"));
			flow.addPort("right", new Port("lr_out", "sending", "Out"));
			flow.addPort("right", new Port("rl_in", "requesting", "In"));
			fixed_interval_rate.addContentItem(flow)
			fixed_interval_rate.addContentItem(new NodeContentParameter("interval", "Interval", "ms", false, 0, null, 1));
			fixed_interval_rate.addContentItem(new NodeContentParameter("rate", "Rate", "packets/s", false, 0, null, 1));
			rate_group.addNode(fixed_interval_rate);

			var trace_rate = new Node("trace_rate");
			trace_rate.setType("trace_rate");
			trace_rate.setTitle("Trace Rate");
			var flow = new NodeContentFlow();
			flow.addPort("left", new Port("lr_in", "requesting", "In"));
			flow.addPort("left", new Port("rl_out", "sending", "Out"));
			flow.addPort("right", new Port("lr_out", "sending", "Out"));
			flow.addPort("right", new Port("rl_in", "requesting", "In"));
			trace_rate.addContentItem(flow)
			rate_group.addNode(trace_rate);

			node_library.addGroup(rate_group);


			var meter_group = new NodeLibraryGroup("Meter");

			var delay_meter = new Node("delay_meter");
			delay_meter.setType("delay_meter");
			delay_meter.setTitle("Delay Meter");
			var flow = new NodeContentFlow();
			flow.addPort("left", new Port("in", "receiving", "In"));
			flow.addPort("right", new Port("out", "sending", "Out"));
			delay_meter.addContentItem(flow)
			meter_group.addNode(delay_meter);

			var throughput_meter = new Node("throughput_meter");
			throughput_meter.setType("throughput_meter");
			throughput_meter.setTitle("Throughput Meter");
			var flow = new NodeContentFlow();
			flow.addPort("left", new Port("in", "receiving", "In"));
			flow.addPort("right", new Port("out", "sending", "Out"));
			throughput_meter.addContentItem(flow)
			meter_group.addNode(throughput_meter);

			node_library.addGroup(meter_group);
		</script>
	</body>
</html>
