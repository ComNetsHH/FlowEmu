<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<link rel="icon" type="image/svg+xml" href="favicon.svg" sizes="any">

		<title>ComNets Channel Emulator</title>

		<link rel="stylesheet" href="css/reset.css">
		<link rel="stylesheet" href="css/ui.css">
		<link rel="stylesheet" href="js/node_editor/node_editor.css">

		<script src="js/jquery/jquery-3.5.1.min.js"></script>
		<script src="js/node_editor/node_editor.js"></script>
		<script src="js/mqtt/mqttjs.js"></script>
		<script src="js/mqtt/mqtt.js"></script>
		<!-- <script src="js/slider.js"></script> -->
	</head>
	<body>
		<div class="header">
			<img class="logo" src="img/comnets_logo.png">
			<!--<a>Channel Emulator</a>-->
		</div>

		<!-- <div class="parameter" parameter="fixed_interval_rate/rate">
			Packet rate: <a class="parameter_value"></a> packet/s<br>
			<input class="parameter_slider" type="range" min="0" max="100000">
		</div>

		<div class="parameter" parameter="fixed_interval_rate/buffer_size">
			Buffer size: <a class="parameter_value"></a> packets<br>
			<input class="parameter_slider" type="range" min="0" max="1000">
		</div>

		<div class="parameter" parameter="fixed_delay/delay">
			Delay: <a class="parameter_value"></a>ms<br>
			<input class="parameter_slider" type="range" min="0" max="250">
		</div>

		<div class="parameter" parameter="uncorrelated_loss/loss_probability">
			Loss: <a class="parameter_value"></a>%<br>
			<input class="parameter_slider" type="range" min="0" max="1">
		</div> -->

		<div class="content">
			<div id="node_library"></div>
			<div id="node_editor"></div>
		</div>

		<script>
			var node_editor = new NodeEditor("#node_editor");

			subscribe("get/module/+", function(topic, message) {
				var r = new RegExp("get\\/module\\/(\\w+)");
				var m;
				if((m = r.exec(topic)) === null) {
					return;
				}
				var node_id = m[1];

				var node_data = (message.length > 0 ? JSON.parse(message) : null);

				if(node_id in node_editor.nodes) {
					if(node_data !== null) {
						node_editor.updateNode(node_id, node_data, false);
					} else {
						node_editor.removeNode(node_editor.nodes[node_id], false);
					}
				} else if(node_data !== null) {
					var node = new Node(node_id);
					node.deserialize(node_data);
					node_editor.addNode(node, false);
				}
			});

			subscribe("get/paths", function(topic, message) {
				var paths_data = (message.length > 0 ? JSON.parse(message) : null);

				if(paths_data) {
					node_editor.updatePaths(paths_data, false);
				}
			});

			node_editor.setNodeAddHandler(function(node) {
				publish("set/module/" + node.id, node.serialize());
			});

			node_editor.setNodeChangeHandler(function(node) {
				publish("set/module/" + node.id, node.serialize());
			});

			node_editor.setNodeRemoveHandler(function(node) {
				publish("set/module/" + node.id, null);
			});

			node_editor.setPathAddHandler(function(path) {
				publish("set/paths", node_editor.serializePaths());
			});

			node_editor.setPathRemoveHandler(function(path) {
				publish("set/paths", node_editor.serializePaths());
			});


			var node_library = new NodeLibrary("#node_library");

			var loss_group = new NodeLibraryGroup("Loss");
			node_library.addGroup(loss_group);


			var delay_group = new NodeLibraryGroup("Delay");

			var node2 = new Node("fixed_delay");
			node2.setTitle("Fixed Delay");
			var flow2 = new NodeContentFlow();
			var node2_port_in = new Port("flow1_in", "In");
			flow2.addPort("left", node2_port_in);
			flow2.addPort("left", new Port("flow2_out", "Out"));
			var node2_port_out = new Port("flow1_out", "Out");
			flow2.addPort("right", node2_port_out);
			flow2.addPort("right", new Port("flow2_in", "In"));
			node2.addContentItem(flow2)
			node2.addContentItem(new NodeContentLabel("Delay: 50ms"));
			node2.setPosition({"x": 450, "y": 50})
			delay_group.addNode(node2);

			node_library.addGroup(delay_group);


			var multiplexing_group = new NodeLibraryGroup("Multiplexing");

			var node4 = new Node("multiplexer");
			node4.setTitle("Multiplexer");
			var flow = new NodeContentFlow();
			flow.addPort("left", new Port("in_1", "In 1"));
			flow.addPort("left", new Port("in_2", "In 2"));
			flow.addPort("right", new Port("out", "Out"));
			node4.addContentItem(flow);
			multiplexing_group.addNode(node4);

			var node5 = new Node("demultiplexer");
			node5.setTitle("Demultiplexer");
			var flow = new NodeContentFlow();
			flow.addPort("left", new Port("in", "In"));
			flow.addPort("right", new Port("out_1", "Out 1"));
			flow.addPort("right", new Port("out_2", "Out 2"));
			node5.addContentItem(flow);
			multiplexing_group.addNode(node5);

			node_library.addGroup(multiplexing_group);

			/* var node1 = new Node("raw_socket_eth0");
			node1.setTitle("Raw Socket");
			var flow1 = new NodeContentFlow();
			var node1_port_out = new Port("out", "Out");
			flow1.addPort("right", node1_port_out);
			var node1_port_in = new Port("in", "In");
			flow1.addPort("right", node1_port_in);
			node1.addContentItem(flow1);
			node1.addContentItem(new NodeContentLabel("Interface: eth0"));
			node1.setPosition({"x": 50, "y": 150})
			node_editor.addNode(node1);

			var node3 = new Node("raw_socket_eth1");
			node3.setTitle("Raw Socket");
			var flow3 = new NodeContentFlow();
			var node3_port_in = new Port("in", "In");
			flow3.addPort("left", node3_port_in);
			var node3_port_out = new Port("out", "Out");
			flow3.addPort("left", node3_port_out);
			node3.addContentItem(flow3);
			node3.addContentItem(new NodeContentLabel("Interface: eth1"));
			node3.setPosition({"x": 850, "y": 250})
			node_editor.addNode(node3);
			
			var path1 = new Path(node1_port_out, node2_port_in);
			node_editor.addPath(path1, false);

			var path2 = new Path(node2_port_out, node3_port_in);
			node_editor.addPath(path2, false);

			var path3 = new Path(node3_port_out, node1_port_in);
			node_editor.addPath(path3, false);

			//var path4 = new Path(node2_port_out, node2_port_in);
			//node_editor.addPath(path4); */
		</script>
	</body>
</html>
